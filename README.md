# Self-Balancing-Bicycle-based-on-Raspberry-Pi

整个调试过程采用模块化的方法，先对各个模块进行离线调试，之后再进行模块联调，最后进行整车调试

- #### 实车改装

  选择从淘宝购买成型的平衡车进行二次开发。淘宝成品的平衡车并没有识别模块。因此我们采用摄像头+树莓派进行车道线的识别与跟踪。下位机只用来维持平衡、控制电机前进以及车把方向。我们利用机器人导论的工具箱中的套件对机械结构进行了改装，增加了树莓派和前置摄像头，摄像头位于车身最前方，斜四十五度向下，确保能够捕获前方的道路线，并且在急转弯的时候也能够提供足够的视野。

- #### 平衡调试

  - 原理

    机械结构的改变意味着系统参数的改变，重心升高。因此需要对外环的PID参数进行调整，适配我们的系统。我们采用串级控制的方法，外环为定制控制采用PD控制器输入平衡点，反馈量为小车的Pitch角，输出电机的转速。内环为随动控制采用PI控制器输入为期望的电机转速，反馈量为编码器测得的电机转速，输出PWM波占空比。

    对于外环控制

    - 比例控制引入回复力
    - 微分控制引入阻尼力
    - 自行车质量一定，重心越高，比例系数越低，微分系数越大
    - 重心位置一定，质量越大，比例系数越高，微分系数越大
    - 因为种种原因，自行车的平衡位置不一定在90°，所以我们通过手动调节静态平衡点的方法帮助保持平衡
    - 先采用纯比例控制器增大比例系数直至等幅震荡，之后加入微分项帮助其保持平衡。

    对于内环控制

    - 通过引入积分项使小车能够保持平衡，而非存在稳态误差。
    - 对于编码器的实际测得转速，我们采用一阶滤波器进行简单的线性滤波。
    - 为了防止电机长时间提留在高转速阶段，我们加入了抗积分饱和的操作，对积分进行限幅。

  - 调试过程

    小车上电维持平衡，手动添加扰动观察小车的运动状态。利用小车套件自带的蓝牙接收模块接收手机端发送的指令，测试转向以及前进。

- #### 通信调试

  - 原理

    	我们利用了树莓派与stm32的串口通信，使用python的serial库进行编程。通信协议包括报文的head，两个int8的控制指令以及报文结尾标志符。控制指令包括前进速度以及转向的角度。速度指令在0~255之间，我们以128作为分解线，大于128为电机正转，小于为电机反转，速度与指令简单的线性映射关系。转向的角度也采用相同的方式。在具体实现过程中，我们用串口转ttl usb的方式借助树莓派的usb口有效地提高了通信的稳定性。

  - 调试过程

    树莓派利用调试脚本发送指令，观察小车的运动状态

- #### 车道线识别调试

  - 原理

    利用x和y方向的**sobel算子**得到图像的梯度图。

    仅保留梯度大于一定阈值的像素作为预处理图，如图所示，白色部分为车道线边缘。

    计算预处理图中每个连通区域的横轴坐标的平均值。

    利用**Kmeans**算法，以所求平均值为各连通域的特征分成两类，即得到左右车道线。

    分别对左右车道线的点用**二次函数拟合**，得到两个二次函数方程。

    将两个二次方程的系数求算术平均值，即得到车道中线的二次函数方程。

  - 调试过程

    我们利用摄像头采集到的离线视频测试了车道线识别模块。观察车道线的识别结果。在用sobel算子提取边缘信息寻找联通区域来确定车道线的过程中，我们发现识别的效果受光线的影响很大。因此我们对整个场地进行了改装并且增加了图像的预处理过程，在摄像头芯片预处理之后再对亮度，对比度进行调节提高视觉算法的鲁棒性。

- #### 规划控制调试

  - 原理

  - 调试过程

    我们利用车道线识别检测得到的结果测试小车的离线轨迹规划，通过肉眼观察轨迹的可行性以及计算平滑度对规划的轨迹进行评价。而最后的跟踪控制的参数调节以及测试在真实场地中进行测试。